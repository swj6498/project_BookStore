<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.WishlistDAO">

    <!-- 찜 추가 -->
    <insert id="insertWish" parameterType="com.boot.dto.WishlistDTO">
        <selectKey keyProperty="wish_id" resultType="int" order="BEFORE">
            SELECT wishlist_seq.NEXTVAL FROM dual
        </selectKey>
        INSERT INTO wishlist (wish_id, user_id, book_id, wish_date)
        VALUES (#{wish_id}, #{user_id}, #{book_id}, SYSDATE)
    </insert>

    <!-- 찜 삭제 (user_id + book_id) -->
    <delete id="deleteWish" parameterType="map">
        DELETE FROM wishlist
        WHERE user_id = #{user_id}
        AND book_id = #{book_id}
    </delete>

    <!-- 찜 ID로 삭제 -->
    <delete id="deleteWishById" parameterType="int">
        DELETE FROM wishlist
        WHERE wish_id = #{wish_id}
    </delete>
    
    <!-- 사용자의 모든 찜 삭제 -->
	<delete id="deleteAllWishByUserId" parameterType="string">
	    DELETE FROM wishlist
	    WHERE user_id = #{user_id}
	</delete>

    <!-- 특정 사용자의 찜 목록 조회 (책 정보 포함) -->
    <select id="selectWishlistByUserId" parameterType="string" resultMap="wishlistBookResultMap">
        SELECT
            w.wish_id,
            w.user_id,
            w.book_id,
            w.wish_date,
            b.book_title,
            b.book_writer,
            b.book_pub,
            b.book_date,
            b.genre_id,
            b.book_price,
            b.book_count,
            b.book_comm,
            b.book_isbn,
            b.book_image_path
        FROM wishlist w
        JOIN book b ON w.book_id = b.book_id
        WHERE w.user_id = #{user_id}
        ORDER BY w.wish_date DESC
    </select>

    <!-- 찜 여부 확인 -->
    <select id="checkWishExists" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM wishlist
        WHERE user_id = #{user_id}
        AND book_id = #{book_id}
    </select>

    <resultMap id="wishlistBookResultMap" type="com.boot.dto.WishlistDTO">
        <id property="wish_id" column="wish_id" />
        <result property="user_id" column="user_id" />
        <result property="book_id" column="book_id" />
        <result property="wish_date" column="wish_date" />
        <association property="book" javaType="com.boot.dto.BookDTO">
            <id property="book_id" column="book_id" />
            <result property="book_title" column="book_title" />
            <result property="book_writer" column="book_writer" />
            <result property="book_pub" column="book_pub" />
            <result property="book_date" column="book_date" />
            <result property="genre_id" column="genre_id" />
            <result property="book_price" column="book_price" />
            <result property="book_count" column="book_count" />
            <result property="book_comm" column="book_comm" />
            <result property="book_isbn" column="book_isbn" />
            <result property="book_image_path" column="book_image_path" />
        </association>
    </resultMap>

</mapper>