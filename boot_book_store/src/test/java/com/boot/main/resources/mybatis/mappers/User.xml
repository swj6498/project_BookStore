<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.UserDAO">

  <select id="findNicknameByUserId" resultType="String" parameterType="String"> SELECT user_nickname FROM users WHERE user_id = #{userId} </select>
  <select id="loginYn" parameterType="hashmap" resultType="string">
        select user_pw from users where user_id=#{user_id}
  </select>
    
  <insert id="register" parameterType="hashmap">
        insert into users(user_id, user_pw, user_email, user_phone_num, user_post_num, user_address, user_detail_address, user_name, user_nickname,user_role) 
        values(#{user_id},#{user_pw},#{user_email},#{user_phone_num},#{user_post_num},#{user_address},#{user_detail_address},#{user_name},#{user_nickname},'USER')
  </insert>
	
  <!-- 	ì•„ì´ë”” ì¤‘ë³µ ì²´í¬ -->
  <select id="checkId" parameterType="string" resultType="int">
        select count(*) from users where user_id = #{user_id}
  </select>
    
  <!--     ì´ë©”ì¼ ì¤‘ë³µ ì²´í¬ -->
  <select id="checkEmail" parameterType="String" resultType="int">
    	select count(*) from users where user_email = #{user_email} AND user_role != 'INACTIVE'
  </select>
    
  <select id="findIdByEmail" parameterType="String" resultType="String">
        select user_id from users where user_email = #{user_email}
  </select>
    
  <!--     ì•„ì´ë””, ì´ë©”ì¼ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì°¾ìŒ -->
  <select id="findPwByIdEmail" parameterType="map" resultType="string">
        select user_id from users where user_id = #{user_id} and user_email = #{user_email}
  </select>
    
  <!--     ì‚¬ìš©ìì˜ ì•„ì´ë””ì™€ ìƒì„±ëœ í† í°ì„ ë°›ì•„, ë°ì´í„°ë² ì´ìŠ¤ í† í°ì„ ì €ì¥(ì‚¬ìš©ìê°€ ì¬ì„¤ì •í•  ê¶Œí•œì´ ìˆìŒì„ ì¦ëª…) -->
  <update id="saveResetToken" parameterType="map">
 		update users set user_pwd_reset= #{user_pwd_reset} where user_id= #{user_id}
  </update>
 	
  <!-- 	 í† í°ìœ¼ë¡œ ì‚¬ìš©ì ì¡°íšŒ -->
  <select id="findUserByResetToken" parameterType="string" resultType="com.boot.dto.UserDTO">
        select * from users where user_pwd_reset = #{user_pwd_reset}
  </select>
 	
  <!--  	í† í°ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸ -->
  <update id="updatePasswordByToken" parameterType="hashmap">
 		update users set user_pw= #{user_pw},user_pwd_reset = NULL where user_pwd_reset= #{user_pwd_reset}
  </update>
 
  <!-- ì•„ì´ë””ë¡œ íšŒì› ì •ë³´ ì¡°íšŒ (ì ê¸ˆìƒíƒœ, ì„¸ì…˜ìš©) -->
  <select id="getUserById" parameterType="string" resultType="com.boot.dto.UserDTO">
        SELECT *
        FROM users
        WHERE user_id = #{user_id}
  </select>
 	
  <!-- ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ ì‹œë„ íšŸìˆ˜ +1, ì‹œê°„ ê°±ì‹  -->
  <update id="updateLoginFail">
        UPDATE users
        SET login_fail_count = login_fail_count + 1,
            last_fail_time = SYSDATE
        WHERE user_id = #{user_id}
  </update>

  <!-- ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì´ˆê¸°í™” -->
  <update id="resetLoginFail">
        UPDATE users
        SET login_fail_count = 0,
            last_fail_time = NULL
        WHERE user_id = #{user_id}
  </update>
    
  <!-- ì´ë©”ì¼ë¡œ ê¸°ì¡´ íšŒì› ì¡°íšŒ -->
  <select id="getUserByEmail" parameterType="string" resultType="com.boot.dto.UserDTO">
	    SELECT *
		FROM users
		WHERE user_email = #{user_email}
		  AND user_role != 'INACTIVE'
  </select>
	
  <!-- ì†Œì…œ ì‹ ê·œ íšŒì› ë“±ë¡ -->
  <insert id="insertSocialUser" parameterType="map">
        INSERT INTO users (
            user_id,
            user_pw,
            user_email,
            user_name,
            user_nickname,
            login_type,
            social_id,
            user_email_chk,
            user_phone_num,
            user_post_num, 
            user_address, 
            user_detail_address,
            reg_date,
            user_role
        ) VALUES (
            #{user_id},
            'SOCIAL_LOGIN',
            #{user_email},
            #{user_name},
            #{user_nickname},
            #{login_type},
            #{social_id},
            'Y',
            '000-0000-0000',
            '47354',
            'ë¶€ì‚°ì‹œ',
            'ë²”ë‚´ê³¨',
            SYSDATE,
            'USER'
        )
  </insert>

  <!-- ğŸ”¥ ë§ˆì´í˜ì´ì§€: ë‹¨ê±´ ì¡°íšŒ (ì—¬ê¸°ì— user_role ì¶”ê°€ë¨) -->
  <select id="selectUser" parameterType="hashmap" resultType="hashmap">
    SELECT
        user_id             AS "user_id",
        user_name           AS "user_name",
        user_nickname       AS "user_nickname",
        user_email          AS "user_email",
        user_phone_num      AS "user_phone_num",
        user_post_num       AS "user_post_num",
        user_address        AS "user_address",
        user_detail_address AS "user_detail_address",
        user_role           AS "user_role",          <!-- â­ ì´ ì¤„ ì¶”ê°€ í•µì‹¬ -->
        TO_CHAR(reg_date, 'YYYY-MM-DD')        AS "reg_date",
        TO_CHAR(last_login_date, 'YYYY-MM-DD') AS "last_login_date"
    FROM users
    WHERE user_id = #{user_id, jdbcType=VARCHAR}
  </select>

  <!-- ë§ˆì´í˜ì´ì§€: ì •ë³´ ìˆ˜ì • (ë¹„ë°€ë²ˆí˜¸ ì œì™¸) -->
  <update id="updateUser" parameterType="hashmap">
    UPDATE users
       SET user_name            = #{user_name, jdbcType=VARCHAR},
           user_nickname        = #{user_nickname, jdbcType=VARCHAR},
           user_email           = #{user_email, jdbcType=VARCHAR},
           user_phone_num       = #{user_phone_num, jdbcType=VARCHAR},
           user_post_num        = #{user_post_num, jdbcType=VARCHAR},
           user_address         = #{user_address, jdbcType=VARCHAR},
           user_detail_address  = #{user_detail_address, jdbcType=VARCHAR}
     WHERE user_id = #{user_id, jdbcType=VARCHAR}
  </update>

  <!-- ì¼ë°˜ ë¡œê·¸ì¸ ì‚¬ìš©ì íƒˆí‡´(ë…¼ë¦¬ì‚­ì œ) -->
  <update id="withdraw" parameterType="hashmap">
    UPDATE users
    SET 
        user_role = 'INACTIVE',
        user_pw = 'DELETED',
        user_email = 'deleted_' || user_id || '@deleted.com',
        user_email_chk = 'N',
        user_phone_num = '000-0000-0000',
        user_post_num = '',
        user_address = '',
        user_detail_address = '',
        user_name = 'íƒˆí‡´íšŒì›',
        user_nickname = 'ë¹„íšŒì›'
    WHERE user_id = #{user_id}
      AND user_pw = #{user_pw}
  </update>


  <!-- ì†Œì…œ ë¡œê·¸ì¸ íƒˆí‡´(ë…¼ë¦¬ì‚­ì œ) -->
  <update id="withdrawSocial" parameterType="map">
    UPDATE users
    SET 
        user_role = 'INACTIVE',
        user_pw = 'DELETED',
        user_email = 'deleted_' || user_id || '@deleted.com',
        user_email_chk = 'N',
        user_phone_num = '000-0000-0000',
        user_post_num = '',
        user_address = '',
        user_detail_address = '',
        user_name = 'íƒˆí‡´íšŒì›',
        user_nickname = 'ë¹„íšŒì›'
    WHERE user_id = #{user_id}
      AND login_type = #{login_type}
  </update>

  <!-- ì†Œì…œ ë¡œê·¸ì¸ ì‹œ ê¸°ì¡´ íƒˆí‡´ ì‚¬ìš©ì ì¡°íšŒ -->
  <select id="getInactiveUser" parameterType="string" resultType="com.boot.dto.UserDTO">
    SELECT *
    FROM users
    WHERE user_id = #{user_id}
      AND user_role = 'INACTIVE'
  </select>

  <!-- ì†Œì…œ ì‚¬ìš©ì ì¬í™œì„±í™” -->
  <update id="reactivateSocialUser" parameterType="map">
    UPDATE users
    SET user_role           = 'USER',
        user_name           = #{user_name},
        user_nickname       = #{user_nickname},
        user_email          = #{user_email},
        user_email_chk      = 'Y',
        user_phone_num      = '000-0000-0000',
        reg_date            = SYSDATE,
        login_type          = #{login_type},
        social_id           = #{social_id},
        user_pw				= 'SOCIAL_LOGIN',
        user_post_num		= '47354',
        user_address 		= 'ë¶€ì‚°ì‹œ',
        user_detail_address = 'ë²”ë‚´ê³¨'
    WHERE user_id = #{user_id}
      AND user_role = 'INACTIVE'
  </update>

</mapper>
