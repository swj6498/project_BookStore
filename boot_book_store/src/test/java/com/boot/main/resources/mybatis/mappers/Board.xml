<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.BoardDAO">

  <!-- ê²Œì‹œê¸€ ë“±ë¡: ì²¨ë¶€ ì´ë¯¸ì§€ ì—†ìŒ, ë‚´ìš©ë§Œ ì €ìž¥ -->
  <insert id="insert" parameterType="com.boot.dto.BoardDTO">
    <selectKey keyProperty="boardNo" resultType="long" order="BEFORE">
      SELECT BOOK_BOARD_SEQ.NEXTVAL FROM dual
    </selectKey>
    INSERT INTO book_board
      (board_no, user_id, board_title, board_content, board_date, board_hit)
    VALUES
      (#{boardNo},
       #{userId},
       #{boardTitle},
       #{boardContent},
       SYSTIMESTAMP,
       0)
  </insert>
	<select id="find" parameterType="long" resultType="com.boot.dto.BoardDTO">
	  SELECT
	    board_no    AS boardNo,
	    user_id     AS userId,
	    board_title AS boardTitle,
	    board_content AS boardContent,
	    board_date  AS boardDate,
	    board_hit   AS boardHit
	  FROM book_board
	  WHERE board_no = #{boardNo}
	</select>
  <!-- ì‹œí€€ìŠ¤ í˜„ìž¬ê°’ (í•„ìš”ì‹œ ì‚¬ìš©) -->
  <select id="selectCurrBoardNo" resultType="long">
    SELECT BOOK_BOARD_SEQ.CURRVAL FROM dual
  </select>
  
  <!-- ì¹´ë©œì¼€ì´ìŠ¤ ìžë™ë§¤í•‘ì„ ì“°ì§€ ì•ŠëŠ”ë‹¤ë©´ resultMapìœ¼ë¡œ ëª…ì‹œ ë§¤í•‘ -->
  <!-- mapUnderscoreToCamelCase=trueë©´ resultTypeë§Œìœ¼ë¡œë„ ë§¤í•‘ë¨ -->
  <resultMap id="BoardMap" type="com.boot.dto.BoardDTO">
    <id     column="board_no"      property="boardNo"/>
    <result column="user_id"       property="userId"/>
    <result column="user_nickname"  property="userNickname"/>
    <result column="board_title"   property="boardTitle"/>
    <result column="board_content" property="boardContent"/>
    <result column="board_date"    property="boardDate"/>
    <result column="board_hit"     property="boardHit"/>
  </resultMap>

  <sql id="columns">
    board_no, user_id, board_title, board_content,
    board_date, board_hit
  </sql>

  <!-- ëª©ë¡(íŽ˜ì´ì§•) : Oracle 12c+ -->
<select id="selectPage" resultMap="BoardMap">
<![CDATA[
    SELECT * FROM (
        SELECT ROWNUM rn, t.*
        FROM (
            SELECT b.board_no, b.user_id, u.user_nickname, b.board_title, b.board_content,
                   b.board_date, b.board_hit
            FROM book_board b
            LEFT JOIN users u ON b.user_id = u.user_id
            ORDER BY b.board_no DESC
        ) t
        WHERE ROWNUM <= #{offset} + #{size}
    )
    WHERE rn > #{offset}
]]>
</select>


  <select id="countAll" resultType="int">
    SELECT COUNT(*) FROM book_board
  </select>

  <select id="selectOne" parameterType="long" resultMap="BoardMap">
  SELECT b.board_no, b.user_id, u.user_nickname, b.board_title, b.board_content,
         b.board_date, b.board_hit
  FROM book_board b
  LEFT JOIN users u ON b.user_id = u.user_id
  WHERE b.board_no = #{boardNo}
</select>


  <update id="update" parameterType="com.boot.dto.BoardDTO">
    UPDATE book_board
    SET board_title   = #{boardTitle},
        board_content = #{boardContent}
    WHERE board_no    = #{boardNo}
  </update>

  <delete id="delete" parameterType="long">
    DELETE FROM book_board
    WHERE board_no = #{boardNo}
  </delete>

  <update id="increaseHit" parameterType="long">
    UPDATE book_board
    SET board_hit = board_hit + 1
    WHERE board_no = #{boardNo}
  </update>
	<!-- ðŸ”Ž ê²€ìƒ‰ ì¡°ê±´ ê³µí†µ(where) -->
<sql id="searchWhere">
  <where>
    <if test="keyword != null and keyword != ''">
      <choose>
        <!-- ì œëª© -->
        <when test="type == 'title'">
          b.board_title LIKE '%' || #{keyword} || '%'
        </when>
        <!-- ë‚´ìš© -->
        <when test="type == 'content'">
          b.board_content LIKE '%' || #{keyword} || '%'
        </when>
        <!-- ìž‘ì„±ìž (user_nicknameì„ ê¸°ì¤€ìœ¼ë¡œ ìˆ˜ì •) -->
        <when test="type == 'writer'">
          u.user_nickname LIKE '%' || #{keyword} || '%'
        </when>
        <!-- ë‹‰ë„¤ìž„ -->
        <when test="type == 'nickname'">
          u.user_nickname LIKE '%' || #{keyword} || '%'
        </when>
        <!-- ê¸°ë³¸: ì œëª©+ë‚´ìš© -->
        <otherwise>
          (b.board_title LIKE '%' || #{keyword} || '%'
           OR b.board_content LIKE '%' || #{keyword} || '%')
        </otherwise>
      </choose>
    </if>
  </where>
</sql>


<!-- ðŸ”Ž ê²€ìƒ‰ + íŽ˜ì´ì§• -->
<select id="searchPage" resultMap="BoardMap">
<![CDATA[
  SELECT * FROM (
    SELECT ROWNUM rn, t.*
    FROM (
      SELECT b.board_no, b.user_id, u.user_nickname, b.board_title, b.board_content,
             b.board_date, b.board_hit
      FROM book_board b
      LEFT JOIN users u ON b.user_id = u.user_id
]]>
      <!-- ë°˜ë“œì‹œ ORDER BY ì „ì— WHERE í¬í•¨ -->
      <include refid="searchWhere"/>
<![CDATA[
      ORDER BY b.board_no DESC
    ) t
    WHERE ROWNUM <= #{offset} + #{size}
  )
  WHERE rn > #{offset}
]]>
</select>

<select id="countSearch" resultType="int">
  SELECT COUNT(*)
  FROM book_board b
LEFT JOIN users u ON b.user_id = u.user_id
<include refid="searchWhere"/>
</select>


</mapper>
