<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="com.boot.mapper.BookMapper">

	<!-- 전체 도서 목록 -->
	<select id="getAllBooks"
		resultType="com.boot.dto.BookDTO">
		SELECT * FROM book ORDER BY book_id
	</select>

	<!-- 전체 장르 목록 -->
	<select id="getAllGenres"
		resultType="com.boot.dto.GenreDTO">
		SELECT * FROM genre ORDER BY genre_id
	</select>

	<!-- 특정 장르별 도서 목록 -->
	<select id="getBooksByGenre" parameterType="int"
		resultType="com.boot.dto.BookDTO">
		SELECT *
		FROM book
		WHERE genre_id = #{genre_id}
		ORDER BY book_id
	</select>

<!-- 전체 개수 -->
<select id="countBooks" resultType="int">
    SELECT COUNT(*) FROM Book
</select>

<select id="recommendByBuy" parameterType="string" resultType="com.boot.dto.BookDTO">
  <![CDATA[
    SELECT *
    FROM (
        SELECT 
            b.*, 
            DBMS_RANDOM.VALUE AS rnd
        FROM Book b
        WHERE b.genre_id IN (
            SELECT DISTINCT b2.genre_id
            FROM Orders o
            JOIN OrderDetail od ON o.order_id = od.order_id
            JOIN Book b2 ON od.book_id = b2.book_id
            WHERE o.user_id = #{userId}
        )
        AND b.book_id NOT IN (
            SELECT od.book_id
            FROM Orders o
            JOIN OrderDetail od ON o.order_id = od.order_id
            WHERE o.user_id = #{userId}
        )
        ORDER BY rnd
    )
    WHERE ROWNUM <= 3
  ]]>
</select>
</mapper>
