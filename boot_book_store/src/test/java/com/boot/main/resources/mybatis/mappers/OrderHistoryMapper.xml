<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.OrderHistoryDAO">

    <!-- 주문 리스트 -->
    <select id="getAllOrders" resultType="com.boot.dto.OrderHistoryListDTO">
        SELECT
            o.order_id,
            o.user_id,
            u.user_name,
            u.user_email,
            o.total_quantity,
            o.total_price,
            TO_CHAR(o.order_date, 'YYYY-MM-DD HH24:MI') AS order_date
        FROM Orders o
        JOIN users u ON o.user_id = u.user_id
        ORDER BY o.order_id DESC
    </select>

    <!-- 오늘 주문 -->
    <select id="getTodayOrders" resultType="com.boot.dto.OrderHistoryListDTO">
        SELECT
            o.order_id,
            o.user_id,
            u.user_name,
            u.user_email,
            o.total_quantity,
            o.total_price,
            TO_CHAR(o.order_date, 'YYYY-MM-DD HH24:MI') AS order_date
        FROM Orders o
        JOIN users u ON o.user_id = u.user_id
        WHERE TRUNC(o.order_date) = TRUNC(SYSDATE)
        ORDER BY o.order_id DESC
    </select>

    <!-- 주문 상단 정보 -->
    <select id="getOrderInfo" parameterType="int" resultType="com.boot.dto.OrderHistoryDetailDTO">
        SELECT 
	        o.order_id,
	        o.user_id,
	        u.user_name,
	        u.user_email,
	        u.user_phone_num,
	        u.user_address,
	        u.user_detail_address,
	        o.total_quantity,
	        o.total_price,
	        o.shipping_fee,
	        o.order_date
	    FROM Orders o
	    JOIN Users u ON o.user_id = u.user_id
	    WHERE o.order_id = #{order_id}
    </select>

    <!-- 주문 아이템 리스트 -->
    <select id="getOrderItems" parameterType="int" resultType="com.boot.dto.OrderHistoryItemDTO">
        SELECT
            od.order_detail_id,
	        b.book_id,
	        b.book_title,
	        b.book_writer,
	        b.book_image_path,
	        od.purchase_price,
	        od.quantity
	    FROM OrderDetail od
	    JOIN Book b ON od.book_id = b.book_id
	    WHERE od.order_id = #{order_id}
    </select>
	
	<!-- 공통 SQL for 목록 -->
    <sql id="orderListFields">
        o.order_id,
        o.user_id,
        u.user_name,
        u.user_email,
        o.total_quantity,
        o.total_price,
        o.order_date
    </sql>

    <!-- 전체 페이징 -->
    <select id="selectPage" resultType="com.boot.dto.OrderHistoryListDTO">
    <![CDATA[
        SELECT * FROM (
            SELECT ROWNUM rn, t.*
            FROM (
                SELECT 
                ]]>
                <include refid="orderListFields"/>
                <![CDATA[
                FROM Orders o
                JOIN users u ON o.user_id = u.user_id
                ORDER BY o.order_id DESC
            ) t
            WHERE ROWNUM <= #{offset} + #{size}
        )
        WHERE rn > #{offset}
        ]]>
    </select>

    <select id="countAll" resultType="int">
        SELECT COUNT(*) FROM Orders
    </select>

    <!-- 검색 페이징 -->
    <select id="searchPage" resultType="com.boot.dto.OrderHistoryListDTO">
    <![CDATA[
        SELECT * FROM (
            SELECT ROWNUM rn, t.*
            FROM (
                SELECT 
                ]]>
                <include refid="orderListFields"/>
                FROM Orders o
                JOIN users u ON o.user_id = u.user_id
                WHERE
                <choose>
                    <when test="type == 'uid'">
                        LOWER(o.user_id) LIKE LOWER('%' || #{keyword} || '%')
                    </when>
                    <when test="type == 'uname'">
                        LOWER(u.user_name) LIKE LOWER('%' || #{keyword} || '%')
                    </when>
                    <otherwise>
                        LOWER(u.user_email) LIKE LOWER('%' || #{keyword} || '%')
                    </otherwise>
                </choose>
                <![CDATA[
                ORDER BY o.order_id DESC
            ) t
            WHERE ROWNUM <= #{offset} + #{size}
        )
        WHERE rn > #{offset}
        ]]>
    </select>

    <select id="countSearch" resultType="int">
        SELECT COUNT(*)
        FROM Orders o
        JOIN users u ON o.user_id = u.user_id
        WHERE
        <choose>
            <when test="type == 'uid'">
                LOWER(o.user_id) LIKE LOWER('%' || #{keyword} || '%')
            </when>
            <when test="type == 'uname'">
                LOWER(u.user_name) LIKE LOWER('%' || #{keyword} || '%')
            </when>
            <otherwise>
                LOWER(u.user_email) LIKE LOWER('%' || #{keyword} || '%')
            </otherwise>
        </choose>
    </select>
    
    <!-- 오늘 주문 내역 페이징 -->
	<select id="getTodayPage" resultType="com.boot.dto.OrderHistoryListDTO">
	    SELECT * FROM (
	        SELECT ROWNUM rn, t.*
	        FROM (
	            SELECT 
	                o.order_id,
	                o.user_id,
	                u.user_name,
	                u.user_email,
	                o.total_quantity,
	                o.total_price,
	                o.order_date
	            FROM Orders o
	            JOIN users u ON o.user_id = u.user_id
	            WHERE TRUNC(o.order_date) = TRUNC(SYSDATE)
	
	            <choose>
	                <when test="type == 'uid'">
	                    AND o.user_id LIKE '%' || #{keyword} || '%'
	                </when>
	                <when test="type == 'uname'">
	                    AND u.user_name LIKE '%' || #{keyword} || '%'
	                </when>
	                <when test="type == 'email'">
	                    AND u.user_email LIKE '%' || #{keyword} || '%'
	                </when>
	            </choose>
	
	            ORDER BY o.order_id DESC
	        ) t
	        WHERE ROWNUM &lt;= #{offset} + #{size}
	    )
	    WHERE rn > #{offset}
	</select>
	
	
	<!-- 오늘 주문 총 개수 -->
	<select id="getTodayTotalCount" resultType="int">
	    SELECT COUNT(*)
	    FROM Orders o
	    JOIN users u ON o.user_id = u.user_id
	    WHERE TRUNC(o.order_date) = TRUNC(SYSDATE)
	    
	    <choose>
	        <when test="type == 'uid'">
	            AND o.user_id LIKE '%' || #{keyword} || '%'
	        </when>
	        <when test="type == 'uname'">
	            AND u.user_name LIKE '%' || #{keyword} || '%'
	        </when>
	        <when test="type == 'email'">
	            AND u.user_email LIKE '%' || #{keyword} || '%'
	        </when>
	    </choose>
	</select>
</mapper>
